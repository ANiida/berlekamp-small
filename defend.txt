アリスと守りの数秘術
私がこの話を書くようになったきっかけ
ある程度暗号に関する知識が身についてくると、その知識を整理するために何かを書きたくなります。
書くことによって、自分が理解していない部分を把握するためです。
この話は、巷にあふれている技術書や専門書のような学問としての側面からではなく、数の持つ神秘、あるいはスピリチュアルな側面から暗号を捉え、それが使われている仮想の異次元ファンタジーとして書くつもりでいます。暗号は技術からの側面だけでなく、なにか不思議な力を持っていて、お守りのように守ってくれる効果があるのでは？という発想から始まり、自然とストーリーが出てきました。
暗号が出てくる小説といえば、江戸川乱歩やエドガー・アラン・ポーなどミステリー小説が思い浮かびますが、私はあえてこのアプローチを取らず、暗号が解かれないことのメリットを強調したいと思っています。
間違ったりわかりにくかったりしているかもしれませんが、その時はぜひ知らせてください。後日訂正いたします。誰かがこの作品を見つけて、少しでも楽しんでいただければ、私にとって望外の喜びです。

あらすじ（まだわかりません）
16歳で大学入学資格試験に合格したアリスは、高校をやめ、ひたすら数秘術の研究に没頭する毎日を送っていた。幼なじみのアルル・カトレイは数秘術の名門校である地元のアルビジョア数術院の天才少年。アリスは大学に行こうか魔術師になろうかと思案していたが、職業の保証がある数術院に入ることを決心し、アルルから教えてもらった数秘術の専門書を読みかじっていた。アリスに興味があったのは守りの数秘術と呼ばれる、数秘術の中でも狭い専門領域であった。魔術の中でも防御や物直し、専守防衛に限った分野の魔術だった。アリスが守りの数秘術に強い関心を持ったのは、子供の頃から内気で神経質で防衛本能が強かったからだが、本人は全く気にしていない。ある日、アリスの住んでいるロマーニャ帝国で封筒で書面を郵送するサービスが廃止され、暗号を使うようにとの指令が出された。これをきっかけに数秘術は大ブームになるのだが、実はその暗号には別の目的があった。その目的とは・・・。みたいな暗号のお話です。暗号ネタのファンタジー小説のつもりですが、興味のある人はどうぞ。


（まだ人に見せる段階でないのに掲載してしまいました。すみません。かろうじてまともなのはアリスと記憶の術とか、プロットとアリスの挑戦状くらいです。まだどう手直しするか決めてません。暗号に興味のない人はつまらないかもしれないですが、ミステリーな要素に暗号を組み入れられたらいいかもしれない。）

アリスは村人たちが使っているビジュネル暗号の解き方がわかってしまったので、どうすれば村人にその危険性を訴えるか考えあぐねていた。もし解読法を教えたとしても、それ以上のいい方法が見つからなければ何になる？何になる？

アリスはまず図書館で線形代数の本を調べてみた。どれもこれも同じような内容ばかりで役に立たなかった。そして行列を魔法に使うための数秘術のコーナーに来たところで、大きな行列が表紙に書いてある、物直しの技の本が目に入った。
その中の一節に次のような式があるのをアリスは見つけた。

As+e=x

アリスはデジャブを感じた。
「これってどこかで・・・アフィン暗号？」

確かアフィン暗号は次のようなものだったはずだ。

f(x)=ax+b

これをa=A,x=s,b=e,f(x)=x書き直すと、全く同じになるではないか。
でも、アフィン暗号は(a,b)が秘密であっても、２つの平文と暗号文のペアがあれば簡単に解かれてしまう。
でもモノ直しの技で使う式は、形は似ていても、ｂの値がランダムなので解読できないのだった。
仮にモノ直しの行列Gが正方行列出会ったとしても、未知のエラーが入っている暗号文ｃに逆行列を掛けたとしても、エラーと平文をうまく分離できるとは限らない。

と、こんなところで止まっている暇はない。
次に戸棚の裏側のコーナーにある守りの数秘術のコーナーに行き、秘密の守り方の本を探した。
しかしアリスはそこそこ成績が良かったが、それでも分厚い専門書は理解できなかったし、かと言って簡単な本には基礎的なことばかりで、新しい暗号については書かれていなかった。

アリスは焦っていた。アリスは自分の直感を信じて、さっきのデジャブの謎を解き始めた。
確かモノ直しの技では次のようにしてデータを直すのだった。つまりある方法で行列Gをつくり、それにデータｓを掛けてエラーeを足す。つまり、

c=sG+e

である。
更にeを取り除くて目にGH=0となるような行列Hを作っておいて、cに誤りが入っていると、ある値が出てくるようにできている。
そしてその値を多項式の係数として扱うことでeを特定するのだった。

一方さっき見た守りの数秘術のの本には、

As+e=x

であり、行列Aと暗号文xがわかっているときに、エラーeを取り除いて平文sを取り出すのであった。
しばらく読み進めてみると、また次のような四季が見つかった。

b(x)=s(x)a(x)+e(x)

この場合もa(x),b(x)が与えられたとき、秘密の多項式a(x),e(x)を計算するものだった。
これにはa(x)を計算するための消去法を使ってAの逆行列をかけてやれば簡単なのだが、
行列Aにエラーが含まれているので平文s(x)を計算する方法が見つかっていないということらしかった。
つまり行列Aは多元連立１次方程式系にエラーを混ぜた暗号文を解読する問題になるということだ。
暗号化鍵にエラーが含まれているなんてもしモノ直しの技だったらとんでもないことになる。
ということはなにか別の構造が行列に仕組まれているのかもしれない。
そうでなくても正しく平文を取り出す別の方法があるのだ。
それは一体どういうものだろう？
もし物直しの技で使う行列とどういう関係があるだろうか？

果たしてアリスは皇帝ロマーニャの陰謀から村人たちを救うことができるのか？（つづくｗ

アリスはしばらく守りの数秘術と物直しの技の本を行ったり来たりして読み比べていたが、ふとひらめいた。

「そうだ、こうすればうまくいくわ！」

まずシステムパラメーターとして素数さ８１９１を方とするリードソロモン符号を公開し、その任意の列をとり、縦と横の比率が１：２になるようにする。片方は単位行列で残りの正方行列Aとなるようにする。ここ任意の列が選択できないと、バイナリ行列を掛けても公開されている正方行列の逆行列で解読されてしまう。
さらにバイナリ展開して、みんなで一人ずつ自分の公開鍵を作るためにランダムなバイナリ行列Bを作って先程作ったバイナリ行列AにかけてBAにする。
こんな風にしても問題がないのは穴開き符号と言われるものがあるおかげだ。
そしてこのBAが公開鍵である。
暗号化するときはこのバイナリ行列BAに、メッセージの列を行列の右から掛けて特定の数のランダムエラーを加える。
これが暗号文だ。
鍵に使われる行は一つ一つ異なるの符号語になっているので、行列のサイズが4✕4だとすると、合計で16のメッセージに8個のバイナリエラーが入れられる。
阻止このランダム行列の1行に対して40このバイナリエラーを加えておく。
これで秘密鍵を持っていない人には公開鍵ににどんな変化があったのかを計算することができなくなる。

たとえリードソロモンだとわかっていても、ランダムバイナリにしてしまえば解読できたという話は聞いたことがないとモノ直し長が言っていた。

バイナリ正方行列の鍵を作るためには、最初にソ対8191から作ったリードソロモン符号から８０行１０４０列という具合に取る。
これはどういうことかといえば、メッセージを表す79次の多項式1040個を、格子の点とものなオシの技で使う係数行列とを同一視して、２つの場合に使い分けているということだ。
ただしｓを値として掛けてしまうと、それはもうモノ直しの技ではなくなってしまうので、式の係数と掛け合わせた総和を右辺の値にするだけの計算だ。
まず平文ｓを暗号化するために０～１０４０個の項に代入した値を連立方程式の右辺の値にする。
次にエラーが入った状態でもう一度ものなオシの技をかけてエラーの位置を特定する情報を集めるという使い方ができる。
メッセージを暗号化するときには係数にエラーは入っていないので、エラーを除去して連立方程式を直せれば、あとは逆行列を右辺のベクトルにかけてメッセージが得られる。
アリスはこの連立方程式の２重性に気づいたのだ。


ものなオシの技で式からエラーの取り除かれた行列は多元連立方程式の係数を意味するから、その逆数を右辺のベクトルにかければ、平文が未知の変数sの答えとして計算できる。
復号できるのは、秘密鍵を持っているる人、つまりスクランブル行列を持っている人だけね。
そして例えばｓが４つの場合、４✕４＋４だけの暗号文ができる。
これを大きくしても村にある小さな計算機でも十分早く計算できるはずだわ。
つまり、これを式で書くと、
$BAs \oplus e = x$
になる。
これは本に乗っていた数秘の式
$As + e = x$
ととても良く似ている。アリスの方法と違うのはAがランダムな行列であることだ。
しかしここまで来てもまだ格子と自分のひらめきがどのくらい違っているのかわかりかねていた。
アリスに唯一わかっていることは、多元連立１次方程式にエラーを入れたものを解読する、ただそれだけだった。

スクランブル行列Bが余分に見えるけど、これは特定の行列をランダムであるように偽装するためにはどうしても必要な行列だった。
でも村人たちに教えるのはきちんと安全であることを確かめてからにしようとアリスは思っていた。
とりあえずバイナリですることにして、８１９１を法とするリードソロモン符号をバイナリ展開する。
と、やればわかるはずなのに、やらない自分は愚かだとアリスは思った。

（間違っているかもしれないですｗ）

n=1040
k=1040=80*13
q=8191
というパラメータをアリスは決めた。
１３が出てくるのはp=8191が１３ビットあるからだ。
バイナリにしたときに生後法行列にするために、[n,k]=[1040,80]のようにしなければならなかった。
オリジナルではpの範囲で収まるランダムな行列だったはずだ。
なのでここはバイナリにして鍵を後悔しないといけない。
そうなるとメッセージsも１ビットサイズになるけど、かまわないわ。とアリスはそう思った。
だってバイナリにするのは解読を防ぐためだし、復号するときには元の整数に戻すんだもの。
志賀島符号とは違う設定を取り入れているため、一体どうするのが正解なのかわからなかった。
とりあえずバイナリの場合に限っておこう。
そうすれば、バイナリ行列のパラメータは[1040,1040]で済みそうだ。
長さ8191を見れば、細長い行列になる。
長さが半分でないので、最後の位置にはエラーが入らないように8191番目の列を削除してしまおう。
すると符号の長さは８１９０＝4095 *2となり、ちょうど半分にすることができる。
しかしここで、まず符号の次元１０４０をどうするかが問題だった。
１０４０は元の整数に戻すと８０この整数からなる多項式だった。
つまり８０この係数を持つ多項式を表しているのだった。
エラーは４０個入れられる。
エラーを入れるのはデータを表現する符号の方なので、受信者はそれを何らかの方法でエラーが入っていることを示す印を計算できないといけない。
もともとそのためのものなオシの技なのでそれはできるだろう。
これは本来なら８１９１＊K*13のパラメータがモテる符号を暗号の強度や計算の歯やすさのために態と小さくしていることになる。
解読しにくくするためにバイナリにしなければならないというのはまだわかる。
でも対角行列にするためにはどうすればいいだろう？
整数の場合なら行列の作法で簡単にできる、でもバイナリでもできるんだろうか？
符号の列は線形独立だからバイナリでもその気になれば対角化できるはずだ。
もともと同じ行列だし、バイナリだからできないというのもおかしな話だ。
長さ１０４０の中の４０個にエラーが入っていれば、これを戻すのはさぞかし大変だろう。
つまり変数ｓが1040個ある式を間違いを正したあとでもとに戻さなければならないのだ。
もとに戻すときには次元１０４０の単位行列を継ぎ足すだけなので、簡単に修正するための情報は計算できる。
符号の長さは依然として８１９０ある。ここで符号の対角要素である１０４０次元の追加情報を付け加えるために２０８０の符号が必要になるので、残りの８１９０から6110だけ符号の列を切り捨ててしまおう。
本当は80なんかよりもっと大きな次元を持っていたほうが皇帝の推薦している暗号なんかより遥かに強くなるはずなのだが、その分時間がかかってしまいそうなのでこのへんは妥協しておいた。
問題は素数だ。小さな素数のべき乗なら見たことはあるが、何故か素体では見たことがない。
それとも普通の格子の技法のように素数を法とした線形符号にのままにしたほうがいいのだろうか？
しかしそれでは簡単に解読できるという話があったではないか。

アリスに降り掛かった問題はこれだった。
拡大体で符号を作ることと、ｐを法とするランダム基底行列を使うことにはなにか根本的な違いがあるのだろうか？
もしリードソロモンを素体で作ればそれはどのような意味をもつのか？
つまりランダムに見える符号ではなく、素体に要素を持つ行列を使うべき根本的な違いが。

アリスは一人で真っ暗な階段を登っていくような気分になっていた。

今まさにアリスはとても不安だ。
最初気づいたときに持っていた自信と期待は全くなくなってしまった。
こういうときは具体例を作ってみるのが一番だ。
物直しの技の中でも形を持たないものを元に戻すには大変豊富な数秘術の知識が必要となる。
それも壊れる前に術をかけておかねばならない。
ある伝説によれば、聖杯を敵に取られる前に持ち出して、物直しの術をかけ、溶かして世界中に撒き散らしたという話もあるくらいだ。
アリスが物直しの術を身に着けたかったのはなぜかそれがとてもファンシーに思えたからだった。

まず簡単な例から試してみよう。
G,Hをそれぞれ$GH^T=0$となるような行列であるとする。そして、

H=
1011100
1101010
0111001
これに対して暗号の生成行列Gは、

G=
1000110
0100011
0010101
0001111

このとき$GH^T=0$であることを確かめた。
これはモノ直しの技の基本である。

さらにG(4,7)にバイナリランダム行列を掛ける。
更にここでGの右からメッセージ(1,0,1,0,0,0,0)を掛けてやる。すると、
(0,0,1,0)が計算できる。そしてこれをG(3,4)の形をしたｍを変数に持つ連立方程式の右辺に設定する。
ここで符号G(3,4)は１エラー訂正できるので、それぞれの行に１エラーずつ、(1,0,0,0),(0,1,0,0),(0,0,1,0),(0,0,0,1)を加えた行列がが暗号文となる。

しかしまだアリスにはうまく言っているかどうかの確証を得られなかった。
しかしこれ以上大きな例を手で作るのは難しい。
そもそも元が1：2の比でなかったのが原因だったので、アリスが想定してパラメータじゃないせいもある。
短縮符号の導出の仕方と、それが適切に使われているかの見分けがつかなかったのだ。

少し式で書いて整理してみよう。

Gはバイナリの物直しの術をかける魔法陣を黒魔法陣とする。
Gにかけると0になる魔法陣を白魔法陣と呼ぶ。$GH^T=0$
Gガチョ方形の場合は0の列を操作してなるべく正方形になるように整形する。

次に魔法陣にスクランブルを掛けて元の魔法陣が何だかわからないようにする。$GS=G'$
次に、言葉にもの直しの術をかけたい場合、メッセージmをGの右側から掛けて、その結果を魔法陣の右の列に並べる。$G'm=x$
魔法陣は変数と同じ個数の行があれば同じ数の未知の文字列を復元できるのだ。
さらにスクランブルを掛けた魔法陣にエラーを入れて、簡単にはメッセージを復元できないような難しい問題に変える。$G'm \oplus e = x'$

これらの手順がアリスの考えた数秘術の流れであった。

アリスの目論見はは、黒魔法陣のサイズを半分にすることだった。
これは符号自体が符号語であることを考えれば、未知の数ある符号の中でどの符号を使っているのかは使う行列の大きさわかりにくくなって来るだけでなく、エラーが入っているので符号にエラーが入っているために解読が難しくなるだろうというものだった、
しかし例を使って説明できても、すべての場合でうまくいくかどうかはわからない。
それを確かめたければ「証明」をしなければならないのだ。
証明という言葉はアリスにとっては数学的帰納法しか知らなかったが、どうやら今やっている問題には使えそうになり。
しかしうまくいかない例ではなく、できるレイだけを扱えばいいのではないか、と思っていた。

少し急ぎすぎたのかもしれない。
アリスは高校入学のプレゼントに貰ったパソコンを持っていた。
これを使えば少し大きな例を使って例を作って実際に計算することができるだろう。
今回うまくいかない例が出てきたのも、魔法陣のパラメータに相性があるからかもしれない。
そしてアリスは少し考えた。

今度は次のような黒魔法陣、白魔法陣を使って実験してみよう。
アリスは自分で書いたプログラムで例を計算して再挑戦することにした。
そしてV(8,15)なる、リードソロモン符号を制した。

```text
検査行列のつもり
 0,11,11,15, 5, 2,15, 1, 9, 1, 6, 4, 7,14, 4, 4,
 5,11,12, 5,12, 5,11, 6,14, 2,14, 7, 3,13,12, 6,
 1,15,12, 6,13,10,10,15, 8,11, 0,13, 1, 5,15,12,
 9, 5, 4, 3, 6,11,11, 3, 7, 6,10,13, 7,13, 5, 6,
 8, 0, 3, 8,12, 4, 0, 0, 8, 4, 4, 5,12, 4, 5, 3,
 0,15,11, 1,15,14,12,13, 4, 3,10,10, 3,12, 2, 1,
 0,15,12,14, 7, 8, 2, 8, 9, 6, 1, 4,13, 5, 6, 8,
 8,15, 6,11, 5, 7,14, 5,14,12,12, 7,11, 7,10,12,

生成行列のつもり
1,0,0,0,0,0,0,0,3,13,8,2,6,7,13,1,
0,1,0,0,0,0,0,0,4,8,9,5,11,14,12,7,
0,0,1,0,0,0,0,0,1,11,14,14,4,13,6,2,
0,0,0,1,0,0,0,0,3,11,4,10,8,2,1,7,
0,0,0,0,1,0,0,0,12,3,12,2,13,9,6,7,
0,0,0,0,0,1,0,0,2,13,11,3,3,15,10,7,
0,0,0,0,0,0,1,0,3,5,9,8,7,10,9,12,
0,0,0,0,0,0,0,1,1,12,3,11,10,3,1,9,

```

しかしこれが暗号として機能するかを知るにはアリスにはまだ距離があった。
かくしてアリスはより難しいリードソロモン富豪に挑戦しようとする気になった。

さてアリスの目標は達成着るのだろうか？

さて、あり図は翌日の朝、まだ朝食前に10分くらいプログラムをして次のことを確かめた。
実験の結果、黒魔法陣と白魔法陣の積は見事に0だった。

（魔法陣を作りたい方がいたらコメントくださいｗ）

# アリス、魔方陣を作る
```c
#include <stdio.h>
#define M 16
#define K 8
#define N 16

unsigned short gf[16] = {0, 1, 2, 4, 8, 3, 6, 12, 11, 5, 10, 7, 14, 15, 13, 9};
unsigned short fg[16] = {0, 1, 2, 5, 3, 9, 6, 11, 4, 15, 10, 8, 7, 14, 12, 13};

//白魔法陣 H
int a[8][16] = {
    {0, 11, 11, 15, 5, 2, 15, 1, 9, 1, 6, 4, 7, 14, 4, 4},
    {5, 11, 12, 5, 12, 5, 11, 6, 14, 2, 14, 7, 3, 13, 12, 6},
    {1, 15, 12, 6, 13, 10, 10, 15, 8, 11, 0, 13, 1, 5, 15, 12},
    {9, 5, 4, 3, 6, 11, 11, 3, 7, 6, 10, 13, 7, 13, 5, 6},
    {8, 0, 3, 8, 12, 4, 0, 0, 8, 4, 4, 5, 12, 4, 5, 3},
    {0, 15, 11, 1, 15, 14, 12, 13, 4, 3, 10, 10, 3, 12, 2, 1},
    {0, 15, 12, 14, 7, 8, 2, 8, 9, 6, 1, 4, 13, 5, 6, 8},
    {8, 15, 6, 11, 5, 7, 14, 5, 14, 12, 12, 7, 11, 7, 10, 12}};

//黒魔法陣 G
int g[8][16] = {
    {1, 0, 0, 0, 0, 0, 0, 0, 3, 13, 8, 2, 6, 7, 13, 1},
    {0, 1, 0, 0, 0, 0, 0, 0, 4, 8, 9, 5, 11, 14, 12, 7},
    {0, 0, 1, 0, 0, 0, 0, 0, 1, 11, 14, 14, 4, 13, 6, 2},
    {0, 0, 0, 1, 0, 0, 0, 0, 3, 11, 4, 10, 8, 2, 1, 7},
    {0, 0, 0, 0, 1, 0, 0, 0, 12, 3, 12, 2, 13, 9, 6, 7},
    {0, 0, 0, 0, 0, 1, 0, 0, 2, 13, 11, 3, 3, 15, 10, 7},
    {0, 0, 0, 0, 0, 0, 1, 0, 3, 5, 9, 8, 7, 10, 9, 12},
    {0, 0, 0, 0, 0, 0, 0, 1, 1, 12, 3, 11, 10, 3, 1, 9}};

int mlt(int x, int y)
{

    if (x == 0 || y == 0)
        return 0;

    return ((x + y - 2) % (M - 1)) + 1;
}

int main()
{
    int i, j, k;
    int c[K][N] = {0};

    // GH=0であることの確認。
    for (i = 0; i < K; i++)
    {
        for (j = 0; j < K; j++)
        {
            for (k = 0; k < N; k++)
                c[i][j] ^= gf[mlt(fg[g[j][k]], fg[a[j][k]])];
            printf("%d,", c[i][j]);
        }
        printf("\n");
    }
    printf("\n");
}

```

こんなことは序の口だ。
問題は暗号なのだ。ヴィジュネル暗号に変わるものを作らなければならない。
おそらく近隣の村の中にも安全性に関する議論ができるものはまずいないだろう。
アリスにしても独学で数秘術を勉強したのだから。

ところでここで問題が起きた。
できると思っていた肝心の短縮符号の具体例が最近の物直しの術の書には全く書かれておらず、
何十年も前の本にわずかに書いてある程度なのだ。
これでは役に立たないのも仕方がない。
さてどうしよう。
このままでは左半分をなくせないので正方行列にできない暗号になってしまう。
色々さがして情報を集めた結果、削除したい黒魔方陣と同じ列に対応する白魔方陣を作れば正方魔方陣は作れるのだと分かった。

幸い公開パラメータのサイズが大きいため、敵が総当たりで鍵を探すことは不可能に近かった。
でもアリスのやりたいことは符号の魔法陣から離れて、エラーの入った式を解く邪教の魔法陣が難しいことを利用した暗号へと向かっていった。

エラーをいれる前にメッセージを暗号化しようとすれば、その魔法陣の行はもう魔法陣の一部とはいえない。
魔法陣の性質から言って右からかけるのと左からかけるのとでは意味が違いすぎる。
しかし結論から言えば、施術した連立方程式にエラーを入れることはできるけれど、逆はないということだ。

つまり、
$As+e=x$（格子）をやろうとして$sA+e=x$（符号）をやる羽目になったとの違いである。
手っ取り早く言うと、方程式系
$x_1s_1+x_2s_2+x_3s_3+x_4s_4=m$
$s=(1,2,3,4)$
であるとすると、方程式は
$x_1+2x_2+3x_3+4x_4=m$
であり、このとき$(x_1,x_2,x_3,x_4)$は魔法陣の成分である。$m_i$はi個の方程式の数でメッセージの数だけ存在する。
$m_i$を方程式系の右辺に置く。このままでは何も起きないが、
次に魔法陣の対角線じゃない右側の方に行列の次元$x_i$と同じ数だけメッセージ$s_i$を右側から掛て別の係数行列として切り分けてておく。
この係数行列を黒魔法陣の左から掛けてやると、無事符号化ができる。
これはなんとなく格子問題に似ている気がする。
因みにGの左半分は単位行列だから、掛けても元の方程式の係数にに変化はない。
なので、さらにエラーを入れれば、順番こそ違えエラー入メッセージ復元問題になりそうな気がする。

このアリスの失敗を明日以降明らかにしていく。


形を持たないモノ直しの術には実に豊富な数秘術が必要になることを以前述べた。
今回はアリスが取り組もうとしている数秘術について予習から始める。
以下のように数がたくさん並んだ四角形を数秘術では魔法陣と呼んでいた。

アリスの数秘術（その１）

```text
//白魔法陣 H（秘密鍵）
int a[8][16]={
{0,11,11,15, 5, 2,15, 1, 9, 1, 6, 4, 7,14, 4, 4},
{5,11,12, 5,12, 5,11, 6,14, 2,14, 7, 3,13,12, 6},
 {1,15,12, 6,13,10,10,15, 8,11, 0,13, 1, 5,15,12},
 {9, 5, 4, 3, 6,11,11, 3, 7, 6,10,13, 7,13, 5, 6},
 {8, 0, 3, 8,12, 4, 0, 0, 8, 4, 4, 5,12, 4, 5, 3},
 {0,15,11, 1,15,14,12,13, 4, 3,10,10, 3,12, 2, 1},
 {0,15,12,14, 7, 8, 2, 8, 9, 6, 1, 4,13, 5, 6, 8},
 {8,15, 6,11, 5, 7,14, 5,14,12,12, 7,11, 7,10,12}};

//黒魔法陣 G（これにランダムバイナリ行列をかければ公開しても良い）
 int g[8][16]={
{1,0,0,0,0,0,0,0,3,13,8,2,6,7,13,1},
{0,1,0,0,0,0,0,0,4,8,9,5,11,14,12,7},
{0,0,1,0,0,0,0,0,1,11,14,14,4,13,6,2},
{0,0,0,1,0,0,0,0,3,11,4,10,8,2,1,7},
{0,0,0,0,1,0,0,0,12,3,12,2,13,9,6,7},
{0,0,0,0,0,1,0,0,2,13,11,3,3,15,10,7},
{0,0,0,0,0,0,1,0,3,5,9,8,7,10,9,12},
{0,0,0,0,0,0,0,1,1,12,3,11,10,3,1,9}};

(gの右側部分)
3,13,8,2,6,7,13,1,
4,8,9,5,11,14,12,7,
1,11,14,14,4,13,6,2,
3,11,4,10,8,2,1,7,
12,3,12,2,13,9,6,7,
2,13,11,3,3,15,10,7,
3,5,9,8,7,10,9,12,
1,12,3,11,10,3,1,9,

m=(2,3,4,5,6,7,8,9)としたときにｇの右側成分にmをかけたものをGで最符号化したもの。
この行列の左半分が、メッセージに関する多元連立1次方程式。
なのでランダム行列を2種類かけて2倍の量のぐろ魔方陣を作り、上下にくっつけてやれば、
ｎこの方程式とｎこのメッせーじを秘密とする多言1次連立方程式が出来上がる。
ここでは手っ取り早くｇを使ったが、本来がランダム行列に右からメッセージをかけ、
それをgで符号化してやりエラーを入れるのが良い。


moの左側部分の抜粋（右からメッセージをかけたもの）
 6, 4, 6,10, 7, 6, 2, 9,
 8,11, 2, 2,15,12,10,10,
 2,14,13, 3,11, 5, 5, 1,
 6,14, 3, 4, 5,14, 8,10,
 11, 5, 5,10, 8,10, 5,10,
 4, 4,10,15,10,11,15,10,
 6,15, 2,14, 1, 3, 4, 6,
 2, 7,12, 1, 9, 9, 8,13,
この行列を黒魔法陣で再変換してやると方程式が魔法陣の中に次のように取り込まれる。

上の行列の左半分にランダムエラーを入れた符号語。魔法陣なのでHと組み合わせればエラーは取り除ける。
ｇに左からランダム行列を掛けた場合はエラーを入れる前と後では区別がつかないので暗号文をｘとして公開しても良い。

最終的に暗号文ｘは次のようになる。
 1, 2,15, 9, 6, 9, 8, 5, 3,14,15,10,13, 2, 0, 7,
 1, 6, 8, 9,13, 7, 9,12, 1, 1,10,13,12,11,11,11,
14,12, 9,11, 0,13, 2,12,10, 4, 6,15, 5, 0, 7, 2,
 0, 4,13, 7, 6, 1, 1, 0,15,15, 8, 5,13,10, 7, 8,
13, 7, 8,13, 9, 2, 6, 0, 9, 8,15,14, 9,13, 4, 8,
 1, 9,15, 8, 2, 2, 1,14,11,10, 0,15, 8, 3,13,13,
13,13,15, 8,10, 7, 0, 7, 0,10, 3,13,11,13,13,13,
12, 5, 8, 0, 8, 4, 4,10, 7, 8, 3, 1, 4,11,11,13,

```

これが$As + e =x$のはずであった。
つまりAが黒魔法陣、ｘは暗号文として公開して、sとeを計算する問題になる。

これを見る前に魔法陣の作り方が気になるだろうが、先にこの魔方陣がどのように使われどのような効果があるのかについて知っておこう。
上のある通り、白魔法陣をH、黒魔法陣をGとする。

法則1：黒魔法陣と白魔法陣を互いに作用させると消える。
法則2：黒魔法陣の異左から何を掛けても、新しくできた要素もまた白魔法陣によって消える。

例えばmoを見てみよう。
moは黒魔法陣の右半分を黒魔法陣自身に作用させ新しく生成した魔法陣である。
実はこれもHによって消えるのだが、その前にもう少し変わった頃とを説明しよう。

法則3・黒魔法陣の要素とならない数はHにより消えず代わりに異端の値が出てくる。

いまやろうとしていることはこれらの原理を応用したものである。
まずGの左側からm=(2,3,4,5,6,7,8,9)を掛ける。
すると
(3,13,8,2,6,7,13,1,)(m1,m2,m3,m4,m5,m6,m7,m8)=4となる。
これはただ単にｍを未知変数として左辺の行列の逆行列を作り、右側の数列にかけてやればいいだけである。
Gに右からかけた8個の数字ｍは、ｍに関する8本の連立方程式となることに注意しよう。
じつはGの右から掛けてしまうと生成された数は異端の数となってHで消えなくなってしまう。
方程式を表す8✕8の係数行列は連立方程式なので、この式をGの仲間にするためにこの連立方程式をGに再入力してやる。
これをG'とかくとG'H=0であり、黒魔法陣の部分に連立方程式を変形できたことになった。
G'を計算するときに、メッセージmを格式に代入して式の係数とともに値を計算しておかねばならない。
いま解こうとしているのは魔法陣に変換した一部なのだから、雑音（異端の数）を入れる前の正しい右辺の計算結果が必要になる。
一方符号化した連立方程式には雑音が入っているので、もう元の正しい方程式には秘密鍵を持っている人以外は戻せない。
さてこのようにGの要素には少し異端の数を入れてもG,Hの性質を使ってそれらを除去できるようになるのだ。
アリスの興味を持った邪教の魔法陣はこれに似ている。
連立方程式に雑音を入れると、その方程式は解くのが難しくなり、雑音が入っていないときには簡単にできる連立方程式の解を求める方法が使えなくなってしまう。仮に逆行列で計算しても、雑音も混じっているので正しくメッセージは計算できない。
そこでアリスは、白と黒の魔法陣を使って方程式に雑音を入れて難しい暗号にできないかと思ったのだ。
そして方程式の右側の数は連立方程式とは関係していて、雑音を秘密鍵を使って訂正する前に、方程式をと変数の数に関わっている。この関係のために使う数字なので変数に当たる平文を解読するためには左側の方程式の計算結果と右側の値が一致しなければならない。これがわかると逆魔法陣から係数消去法という技が使えるようになり、見事にメッセージを復元できるというわけである。

ここでアリスが誤解していたのは、短縮符号を使って魔法陣を短くして正方形にできると思っていたところだ。

しかし、よく考えてみれば、オリジナルの黒魔法陣が１：２の比であるからといって、暗号のために生成される魔法陣も長方形でなければならないということではない。
つまりｇを使って2つの魔法陣をくっつけてやれば正方形のn次元魔法陣となりn個のメッセージを送ることができるではないか。
もしそうなら、黒魔法陣により生成された多元連立一次方程式の半分だけを方程式に使うなどという不自然なことをしなくても住む。
これは黒魔法陣で生成できる呪文の数に制限がないことを意味する。
そのためには黒魔法陣の左かランダム行列を2種類選んでかければいい。
その上で、n個のメッセージを右からかけ、計算結果を多項式系の右辺にする。
あとはランダムにn/4個のエラーをｎ本の四季にそれぞれ入れてやればもう何をエラーにしたかはわからない。
このように、最初にアリスが望んだ正方形の魔法陣は出来上がった。
```text
{0,11,11,15, 5, 2,15, 1, 9, 1, 6, 4, 7,14, 4, 4},
{5,11,12, 5,12, 5,11, 6,14, 2,14, 7, 3,13,12, 6},
 {1,15,12, 6,13,10,10,15, 8,11, 0,13, 1, 5,15,12},
 {9, 5, 4, 3, 6,11,11, 3, 7, 6,10,13, 7,13, 5, 6},
 {8, 0, 3, 8,12, 4, 0, 0, 8, 4, 4, 5,12, 4, 5, 3},
 {0,15,11, 1,15,14,12,13, 4, 3,10,10, 3,12, 2, 1},
 {0,15,12,14, 7, 8, 2, 8, 9, 6, 1, 4,13, 5, 6, 8},
 {8,15, 6,11, 5, 7,14, 5,14,12,12, 7,11, 7,10,12},
{0,11,11,15, 5, 2,15, 1, 9, 1, 6, 4, 7,14, 4, 4},
{5,11,12, 5,12, 5,11, 6,14, 2,14, 7, 3,13,12, 6},
 {1,15,12, 6,13,10,10,15, 8,11, 0,13, 1, 5,15,12},
 {9, 5, 4, 3, 6,11,11, 3, 7, 6,10,13, 7,13, 5, 6},
 {8, 0, 3, 8,12, 4, 0, 0, 8, 4, 4, 5,12, 4, 5, 3},
 {0,15,11, 1,15,14,12,13, 4, 3,10,10, 3,12, 2, 1},
 {0,15,12,14, 7, 8, 2, 8, 9, 6, 1, 4,13, 5, 6, 8},
 {8,15, 6,11, 5, 7,14, 5,14,12,12, 7,11, 7,10,12}};

こうすればいい。
```


つまり、魔法陣を呪文に作用させるということは更に呪文を魔法陣の中に取り入れることができるのだ。
こうすることで異端の数を見つけることができるのだが、それはあとに解説する。
これだけでも十分に難しいかもしれないが、それは後々詳しく明らかにしていこう。


さてアリスが見つけた村で使っていた暗号の作者は微ジュネルであった。
しかしこれは、平文と暗号を持っていれば誰でも秘密鍵がわかってしまうというものだった。

そこでアリスは数秘術を使い、新しい暗号を作らなければならないと思うようになった。
ビジュネル暗号は皇帝ロマーニャのお墨付きの安全な暗号であったので、これが解読できたと知られると大騒ぎになる。

一方前回までで、エラーの入った連立方程式が難しいことを利用した暗号は安全であるらしいことがわかった。
そこでビジュネル方陣のように黒魔法陣を使って暗号を作ることをアリスは思いついた。

公共のパラメータ：
まずだれにでも見えるように数秘術（アリスはまだ知らない）を使って８✕１６の表を公開する。

鍵生成：
次に使用者個人の黒魔法陣を作るために、バイナリ正則行列をかけてやる。
ビジュネル方陣が２６✕２６だったのに対して、アリスの魔法陣は１６✕１６である。
なぜ１６で暗号化できるのかといえば、メッセージに番号をつけ、それを４桁ごとに分割しながら暗号化するからである。
本当は公開されている表もバイナリに展開されていなければならないが、ここではどちらも１６までの数でできているとする。
すると、なんと表が公開されているにも関わらず、一度この行列、スクランブル行列を掛けてしまえば、元の行列がなんであったのかを知ることはとても難しいらしい。ただしスクランブル行列は誰にも知られてはならない秘密である。

暗号化
自分だけの黒魔法陣を２つのスクランブル行列作って２つ作り、この黒魔法陣を上下に配置し、正方形になるようにする。
次にその魔法陣を使ってメッセージを魔法陣の右から掛ける。
このときできた数値は連立方程式の右辺になる。
最後に左辺の魔法陣にエラーを加えて暗号文の出来上がりである。
結果、この暗号文のサイズはメッセージの数をｎとすると、$n^2+n$である。

復号
アリスはまず暗号文を上下半分に分け、それぞれに白魔法陣を掛ける。
この魔方陣は数秘術と物治ししの技と療法を使っているためにとても難しく、アリスは具体例を探してきてそれを変形して計算していた。
この暗号文は黒魔法陣を使って１行ずつ作られているので半分に分けて１行ずつ白魔法陣にかけてやれば、異端の数はかならず見つかる。
するとエラーが入っていることを示す異端の数が出て来る。
そして異端の数にありす歯科知らない秘密の行列を掛けてやり、本当の数に戻してやる。
異端の数とその意味するものは表にしてあり、どの数がどのエラーに対応しているかの一覧表を使って暗号文を書き換える。
すべてのエラーが取り除かれると、正しい連立方程式が出来上がるので、左辺の逆行列を右辺にかければ、ｎ個のメッセージが復元できる。

これがアリスの考えたした暗号である。
もしかしたらこれでも安全じゃないかもしれないので、安全性の評価は先に進んでから行うこととする。

アリスはビジュネル暗号の攻撃方法を公開すべきかどうか悩んでいた。
開発者本人に伝えるのはいいかもしれないが、方法をほかに人に見られて拡散するかもしれないし、
それを考えると何より皇帝が怒るかもしれない。
このまま黙っていようか？

他にも気づいたことがあった。
アリスが考えた方法も実は間違っているかもしれないことに気づいたのだ。
モノ直しの技を右からメッセージをかけても、暗号を生成できるのだろうか？
左からかけてうまくいくのは、それが暗号同士を足すだけで済むからだが、右からかけたら係数が変わってしまうので、それはもはや復号できない数列になってしまう。
つまり黒魔方陣の列同士を足すことになる。

モノ直しの技を右からかけて連立方程式になるかもしれないが、それではエラーを入れることができない。
これ以上モノ直しの技と守りの技についてかかわるのをやめておくべきだろうか？
どうしてエラー入り連立方程式が難しいのか、アリスは見誤っていたのだ。
誰にも言わかなかったからよかったものの、アリスは自分の暗号が間違っていたことに失望を感じた。
もしこれを実現したければ、暗号文はモノ直しの技と数秘術の両方の性質を持たなければならない！

やっぱり思い付きはよくない。

この失敗を教訓に、まず守りの数秘術という本を図書館できちんと読んで勉強しなければならないとアリスは思った。

やっぱり黙っていよう。
このまま何もしなくても暗号を解読する方法があるというのは私のせいじゃないし、代わりになる方法がないのに行っても混乱するだけだと思った。

アリスが図書館に行ってみると、村の外れにある数秘術の名門校、アルビジョア数術院、別名エコール・マジカル・スペリオール（EMS）の修道僧のアルルが来ていた。
アルルがアリスに気が付くと、アリスが持っている本を指さして

あれ？君も数秘術を調べに来たの？僕はいつもの通りだ。

といった。アリスは言いにくそうに答えた。

そうなんだけど、アルルに合うとは思わなかったわ。ちょっと悩みを抱えていて、図書館に来れば分かると思って。

と、自分の暗号の失敗について話し始めた。

モノ直しの技と守りの数秘術を使って新しい暗号を作ろうとしたけどだめだったと話した。
それと、その原因である暗号文が魔方陣に含まれずに暗号として機能しなくなる理由も説明した。

アルルは少し考えてこう言った。

確かに列を足すのは無理があるけど、列の向きを変えて行にしたら右からかけてもうまくいくかもしれないね。

といった。

おお、すごいわアルル。ちょっと考えただけでそんなことを思いつくなんてさすがだわ。
確かに縦はモノ直しの技、横が連立数秘術になっているわ。
修道院で密使から受け取る暗号を毎日復号してるんでしょう？
もっと教えてよ、数秘術のこと。

だめだめ、ここから先は立ち入り禁止。
それに院長は女の子には近づくなって言われているんだ。

わかったわ、ここから先は自分で考えることにする。
アルルまたね。

さて、アリスの暗号はどうなるのでしょうか。


物語の設定：
神聖ロマーニャ帝国：皇帝はロマーニャ
文化レベルは２１世紀くらい、魔術と数学、中世と現代が混在する世界で、暗号と呼ばれる計算困難な問題が存在するクリプトマニアの世界でもある。
登場人物
アリス：主人公、数理魔術の見習い
アルル・カトレイ：異端キリスト教カタリ派の少年修道僧
カトレイ院長：村の外れにある修道院の院長。アルルの育ての親。
パレーシャ：アルルの親友
カタリ派の教義：
人間の肉体は悪魔の産物であり、人間にできる唯一の善は自殺すること、世界は神に裁かれた後であり、人間は地獄に生きている、教会の権威を否定し信仰を公言せずに個人的に崇拝することが信仰を純化するなどネガティブな教義が多い。結婚は肉を増やすことになるので禁じられている。


アリスの暗号は安全かどうか保障がつけられなかった。
他の誰かにはこの暗号の欠陥がわかるかもしれない。
遠く離れた町ではヒル暗号という別の暗号が安全だといわれているし、ほかにもアフィン暗号が安全だという人もいる。
どれが安全なのかは誰にもわからない。
一番詳しいのがアルルのいる僧院で集会の時間に行われている知恵の秘儀に関する議論や暗号品評会だった。
アリスは１週間ほど悩んだ挙句、アルルに相談することにした。
アルルの僧院には行けない。
いっても門番が通してくれない。
アリスは一か月ほど図書館にアルルが来るのを待っていた。

そしてついにアルルに合うことができた。

やあ、また会ったね。
相談があるの
暗号のこと？
村で使われている暗号が解けたの。
へえ。
みんな安全だって信じてるわ。みんなに話して使うのをやめさせようと思うんだけどどう思う？
ビジュネル氏にも手紙を送ってみようかと思うんだけど。
それはやめた方がいいね。村人くらいならいいけど。
どうして。
あの暗号に解読法があるという事はずっと昔から知られている。知恵の秘儀を知っている人には使ってはならない方法として有名なんだ。そこで考えられるのは、皇帝が情報収集のためにわざと解読できる暗号を使わせているという可能性だ。
それは怖いわね。
君が皇帝に勝てる自信があればやってもいいと思うけど。
ないわ。
君が見つけた解読法は３番目に強い解読法だね。
どうして知ってるの？！
このノートは君のだよね。
私の捨てた計算ノート？プライバシー侵害ね。
僧院でも情報収集を行っているんだよ。
このノートは僧院の販売所で買ったものだね。
思い出したわ、あそこは女からは２倍のお金をとるのよね、二度と行かないわ。それでそのノートにある計算から私が何をしているのかわかったの？
うん。
どうやって？
記憶の術を使った。
記憶の術？
そう。このノートにはモノ直しの技がかけられている。このノートが何の目的で使われたのか記憶がわかるんだ。
そんな書き込みから記憶がわかるの？
君も知っているように、見えないものにモノ直しの技をかけることが一番難しいよね。このノートに書かれたことは人の思考のごく一部から、その人が何を目的に何をしようとしているのかを復元できるんだ。販売所で売られているノートには全部モノ直しの技がかけられている。
そういうことだったのね。私もやってみるわ。ただし別の方法でね。
何をする気なんだ、アリス。
ビジュネル氏を試すのよ。うまくいったら報告するわ。またねアルル。

アリスはそういってその場を去った。
早速ビジュネル氏に解読に成功したことを知らせる方法を考え出した。
その前に、町の郵便局で売られている匿名電報を買わなければならない。
今日は乗合馬車の予約をしておこう。

※ちょっと誤解してました。
A,ｂは公開鍵であって、暗号文ではないです。
LWEを使った公開鍵は次元ｎの縦ベクトルで、エラー入り符号になります。
行列Aは公開パラメータで係数ｓとエラーeで個人鍵を作っている。
秘密鍵は連立方程式の係数ｓなので、この秘密鍵を使って平文を復号できなければならないが、
今迄のやり方だと肝心のｓを何も使っていない。
暗号化はまず次元ｎのランダム横ベクトルｒをAの左からかけてC1と置く。
次に、ランダムベクトルｒと公開鍵の積に（数字1つ？）平文を加えたものをC2として暗号文（C1,C2）とする。
つまり乱数を符号化してエラーを加えた符号語が公開鍵になるのとほぼ同じ？感じがします。
復号は乱数ベクトルが共通していることから、
$C1 \*s-C2=rAs-r(As+e)=-r*e-m$
として最終的にｍを計算するようですが、共通している乱数ベクトルを復号に使っていることから、
エルガマル的な暗号のように見えます。
で、これって符号でできるんでしょうか？ｗ
LWEが秘密鍵になると、符号を使ってどこまで鍵を小さくできるのかが気になります。
これを踏まえてどうやって秘密鍵暗号を構成するかについて考えてみたい。
前の話を書く前に次の話が決まってしまったｗ

----
まずだれにでも見えるように数秘術（アリスはまだ知らない）を使って８✕１６の表を公開する。」
この部分は以下のようになる。
鍵生成のもとになるのは多項式だが係数を考慮すると鍵空間は高々３２ビットしかない。

```c
//黒魔法陣 G
int g[8][16] = {
    {1, 0, 0, 0, 0, 0, 0, 0, 3, 13, 8, 2, 6, 7, 13, 1},
    {0, 1, 0, 0, 0, 0, 0, 0, 4, 8, 9, 5, 11, 14, 12, 7},
    {0, 0, 1, 0, 0, 0, 0, 0, 1, 11, 14, 14, 4, 13, 6, 2},
    {0, 0, 0, 1, 0, 0, 0, 0, 3, 11, 4, 10, 8, 2, 1, 7},
    {0, 0, 0, 0, 1, 0, 0, 0, 12, 3, 12, 2, 13, 9, 6, 7},
    {0, 0, 0, 0, 0, 1, 0, 0, 2, 13, 11, 3, 3, 15, 10, 7},
    {0, 0, 0, 0, 0, 0, 1, 0, 3, 5, 9, 8, 7, 10, 9, 12},
    {0, 0, 0, 0, 0, 0, 0, 1, 1, 12, 3, 11, 10, 3, 1, 9}};

//公開パラメータ
3,13,8,2,6,7,13,1,15,11,3,8,7,5,10,6,
4,8,9,5,11,14,12,7,14,15,8,15,6,2,5,13,
1,11,14,14,4,13,6,2,2,14,4,2,8,0,13,3,
3,11,4,10,8,2,1,7,12,14,11,11,15,13,4,9,
12,3,12,2,13,9,6,7,14,4,11,7,2,5,1,11,
2,13,11,3,3,15,10,7,9,8,0,2,13,7,2,2,
3,5,9,8,7,10,9,12,1,7,11,6,6,2,14,2,
1,12,3,11,10,3,1,9,6,10,11,14,12,7,7,10,
```



「鍵生成：
鍵のベースとなるｇの後半をg自身で符号化している。（何のためだか忘れた）
次に使用者個人の暗号化鍵を作るため、左からこの行列を転置したものにランダム正則行列をかける。
秘密鍵は２つの8×8ランダム正則行列S1、S2と、S1,S2によってランダム化された16×16行列が使われる。」

「暗号化：
暗号化には右から平文の積を計算し、その結果が連立方程式の右辺になるようにする。
さらに右から置換行列を掛ける。
そしてその行列に各列に対して重みが４のエラーを入れる。（縦か横か忘れた）
これはこの連立方程式が解けないようにするためである。

ビジュネル方陣が２６✕２６だったのに対して、アリスの魔法陣は１６✕１６である。
バイナリ計算のほうが安全だが、ここではどちらも１６までの数でできているとする。
スクランブル行列は誰にも知られてはならない秘密である。」

わかりにくいかもしれないが、以下のこと。
```c
スクランブル前（上下に同じ符号を並べる）
 3,13, 8, 2, 6, 7,13, 1,15,11, 3, 8, 7, 5,10, 6,
 4, 8, 9, 5,11,14,12, 7,14,15, 8,15, 6, 2, 5,13,
 1,11,14,14, 4,13, 6, 2, 2,14, 4, 2, 8, 0,13, 3,
 3,11, 4,10, 8, 2, 1, 7,12,14,11,11,15,13, 4, 9,
12, 3,12, 2,13, 9, 6, 7,14, 4,11, 7, 2, 5, 1,11,
 2,13,11, 3, 3,15,10, 7, 9, 8, 0, 2,13, 7, 2, 2,
 3, 5, 9, 8, 7,10, 9,12, 1, 7,11, 6, 6, 2,14, 2,
 1,12, 3,11,10, 3, 1, 9, 6,10,11,14,12, 7, 7,10,
 3,13, 8, 2, 6, 7,13, 1,15,11, 3, 8, 7, 5,10, 6,
 4, 8, 9, 5,11,14,12, 7,14,15, 8,15, 6, 2, 5,13,
 1,11,14,14, 4,13, 6, 2, 2,14, 4, 2, 8, 0,13, 3,
 3,11, 4,10, 8, 2, 1, 7,12,14,11,11,15,13, 4, 9,
12, 3,12, 2,13, 9, 6, 7,14, 4,11, 7, 2, 5, 1,11,
 2,13,11, 3, 3,15,10, 7, 9, 8, 0, 2,13, 7, 2, 2,
 3, 5, 9, 8, 7,10, 9,12, 1, 7,11, 6, 6, 2,14, 2,
 1,12, 3,11,10, 3, 1, 9, 6,10,11,14,12, 7, 7,10,

スクランブラ1
 9, 2, 4,11, 9, 5, 8, 9,
14, 0, 2, 0,10, 8, 8, 6,
 4, 9, 7, 5,10,15, 0, 4,
12, 9, 7, 3,13, 6, 0, 7,
 5,12, 6,12,12, 2, 4,10,
11,15,12, 4,15,15, 7, 3,
 7, 8, 1,13,15, 9, 6, 5,
 7, 4, 7,13, 2, 5, 2, 5,
スクランブラ2
 0, 7,14,12, 5,15, 5, 2,
 3,10, 2, 5, 4, 5, 4, 2,
 8, 8, 5, 0,10, 2, 9,14,
 5,14, 9, 1,12, 5,12, 4,
 1,12, 1, 0,11,12, 6, 1,
 3, 2, 3, 9,10,15, 6,12,
15,13, 4,13,15, 4, 3, 1,
 4, 3, 8, 6,12, 9, 8,10,

error table =（暗号化するたびに変わる。確率的暗号。
なぜ復号できるかというと暗号文が誤り訂正符号だから）
 0, 0, 0,12, 0, 7,11,11, 0, 8,14, 2, 0, 0, 9, 0,
 0, 0, 4, 0,14, 9, 0, 0,11, 0, 0, 0, 0, 0, 4,11,
12, 6,11, 0, 0, 0, 0,12, 0, 8, 5,15, 9,14, 0, 0,
 9,14, 0,14, 0, 1,15, 0,15, 0, 5,12, 0, 4, 6, 6,
 0, 0,14,12,12, 0, 4,10, 8,13,11, 6, 8, 3, 9,14,
 0, 0, 0, 0, 0,15, 4, 0,13, 0,12, 0,12, 0,14, 1,
 7, 0,13, 0, 1, 0, 0, 0, 0, 0,12, 0, 0, 5, 0, 0,
 0,13,12, 0, 0, 8, 0, 8, 0,14, 0, 0,12, 6, 9, 0,
 4,11,15,12, 5, 0,14, 0, 0,14, 0, 4,14, 0, 0, 3,
 0, 8, 0, 0,11, 8, 0, 0, 2, 0, 0, 5, 0,11, 0, 9,
 0, 6, 0,12,11, 0, 0, 0, 5, 0,10, 0,10, 0, 0, 8,
10, 0, 0,11,12, 1,12,15,10,10, 1, 0,12, 0, 0, 0,
10, 0,10,11, 5, 0, 0, 9,10, 0, 0, 0, 0,12, 1, 0,
 9, 7, 1, 0, 0, 0, 4, 3, 0, 9, 0, 0, 0,15, 0, 0,
 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 4, 3, 0, 7,10,
 1, 3, 0, 2, 0, 5, 0,11, 0,12, 0, 3, 0, 0, 0, 0,

平文：
nt n[16] = {2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 1, 0};

「スクランブル後
cは暗号化された平文の一部。暗号文全体のサイズはｎ×ｎ＋ｎである。
この計算結果にエラーを入れると暗号文になる。
今回のプログラムではスクランブラでランダム化した行列をもとに戻す計算まで載せている。」

スクランブル後（暗号文：エラーなし）
 4, 3, 9,10,10,13,14,14, 3, 0, 6,10,13, 3, 4,10, c[0]=13
12, 0,14,15,14, 4, 2,13,12, 1, 3,10, 1, 8,14,15, c[1]=6
14,15,14, 4, 1, 4, 2, 2,10,10,14, 4, 2,10,15, 7, c[2]=15
15, 3, 2, 6, 1, 4, 1,15,14, 9, 0, 1,13, 7, 4, 9, c[3]=0
 6,12,10, 9, 3, 7, 9, 5, 9,14, 6,12, 3, 6, 6,11, c[4]=14
 8,10,10, 5, 1, 8, 5,14,14, 9, 9,10,15, 7, 3, 0, c[5]=10
12,13,14, 4,10,13, 3, 9, 0, 9,10, 6, 0,13, 5, 5, c[6]=8
11, 8, 6, 7,10, 8, 0, 5, 0, 7, 7, 7,10, 0,15, 9, c[7]=8
15, 9, 3, 1, 2,14, 4, 0, 8,13, 8,14,11, 0, 2, 3, c[8]=9
 7, 3, 6,13, 8, 0, 3,15, 7,11, 6, 3, 1,13,10, 3, c[9]=15
11, 4, 3, 3, 4, 4, 8, 3,14, 4, 6, 8,15,10, 8, 9, c[10]=11
14, 5,14, 0,15, 3, 2, 8, 8,10, 5,10,13, 5, 1, 4, c[11]=5
10, 0, 0, 9, 5, 0, 8, 0, 7, 6, 0, 4,12, 6,11, 2, c[12]=11
12,13,15, 5,14, 2, 6, 1,13,10, 6, 1, 8, 5, 6, 9, c[13]=7
 7, 9,11, 6,11, 0, 1,13, 9,15, 3,15, 8, 9, 1,14, c[14]=9
13, 5, 6,10, 8,10, 0, 8,13, 7, 6, 8,13,10,15, 0, c[15]=1

公開パラメータｇをスクランブル行列でランダム化することで個人鍵を生成する。
エラーのない状態では左辺の行列の逆行列を右辺のｃにかけてやれば平文が得られるはず。
個人鍵はスクランブラーの逆行列を掛けると元に戻る。

cheki「元の鍵に戻った」
3,13,8,2,6,7,13,1,15,11,3,8,7,5,10,6,
4,8,9,5,11,14,12,7,14,15,8,15,6,2,5,13,
1,11,14,14,4,13,6,2,2,14,4,2,8,0,13,3,
3,11,4,10,8,2,1,7,12,14,11,11,15,13,4,9,
12,3,12,2,13,9,6,7,14,4,11,7,2,5,1,11,
2,13,11,3,3,15,10,7,9,8,0,2,13,7,2,2,
3,5,9,8,7,10,9,12,1,7,11,6,6,2,14,2,
1,12,3,11,10,3,1,9,6,10,11,14,12,7,7,10,

3,13,8,2,6,7,13,1,15,11,3,8,7,5,10,6,
4,8,9,5,11,14,12,7,14,15,8,15,6,2,5,13,
1,11,14,14,4,13,6,2,2,14,4,2,8,0,13,3,
3,11,4,10,8,2,1,7,12,14,11,11,15,13,4,9,
12,3,12,2,13,9,6,7,14,4,11,7,2,5,1,11,
2,13,11,3,3,15,10,7,9,8,0,2,13,7,2,2,
3,5,9,8,7,10,9,12,1,7,11,6,6,2,14,2,
1,12,3,11,10,3,1,9,6,10,11,14,12,7,7,10,
```
これを式で書くと、16×16行列をA（秘密鍵）とし、平文をｍ、連立方程式の右辺をｂとすると、

$Am+e=b$

となり、Aとbがわかっていてもmとeはわからないようにしているつもり。
このままだと行列が固定されるので、今風に言うnonceやIV（初期ベクトル）など、暗号化にランダム性を持たせるような、何らかのパラメータが必要になる。
このままじゃ線形変換じゃないかという不安もあるのでその解消法も調べてみたい。
現時点で符号は$GF(16)=GF(2^4)$だが、文献

https://eprint.iacr.org/2009/589.pdf

より、$GF(17)$のほうがいいらしい。

アリスの暗号は秘密鍵暗号のつもりなので、実際の秘密鍵はスクランブラだけである。
誤解指定かもしれないが、これがLWE暗号のミニチュアのつもりである。
鍵のサイズは１６×８×４＝512ビット・・・のつもりです。
これに右から置換群をかけてもいい。
今の段階では、Aが固定されているためAを暗号文にしても、Aとの差分を計算すればeが計算できるはず。
なので解釈が間違っているのかLWEは符号で構成できないのでは？との疑問からわかりました。
暗号解読の記事（ヒル暗号）も書く予定。
今回はここまで。

コードが見たい方はいないと思いますがコメントしてください。

アリスは2,3日待ってみたが、ビジュネルからの返事はなかなか来なかった。
そのうちアリスは退屈になって、知恵の秘儀を読み始めた。
中には確かに使ってはいけない暗号や、魔法文字の解読の方法、アルルが知ってそうなことがたくさん乗っていた。
しかしなにせ200年も前の本だったので流石に情報が古かった。
そこで新刊がないかどうか調べてみた。
本の出版元は100人委員会と書かれていた。

100人委員会？実在するのね。ずっと歴史上の仮想の団体だと思っていたわ。

新刊である現代数秘術はあるが、専門書だったので6000円もした。
作者は数理魔術の養成校で教えている人のものだった。

これほしいなあ。貯金使っちゃおう。
でもどうやって取り寄せればいいのかしら。
アルルに頼んでも断られそうだし。
なにせあいつはプロの魔道士だから、お金出さないで魔法なんか使ってくれないし。

アリスはしばらく考えて思いついた。

そうだ！匿名電報権を使えばいいんだわ！
匿名電報権に自分のほしい本のIDを書いての本の名前と出版元を郵便局に送って局にいる魔道士に取り寄せの術を使って取り寄せてもらうのよ。
郵便局ならあらゆる組織の公開鍵が登録されているから、鍵に魔法を使って取り寄せられる。
匿名電報権は私の住所を知らない。
受取先を近くのコンビニにしておけば私の住所を記録されずにすむ。
これで安心して最新の数理魔術の本が手に入るわ！

アリスがすべての情報を書き終わると、匿名電報権はさっと金粉のように光って郵便局まで送信された。
空間ポストって便利ねえ。

そんなことで感心している場合ではない。
翌日待望の数理魔術の新刊をコンビニに取りに行った。
タイトルが見えないように梱包されていた。
そしてその本には、アルルの使っていた見えないものに物直しの技をかける方法もきちんと書かれてあった。
それだけでなく更に難しい最新の魔法についても書かれてあった。

これでアルルに近づける・・・かも。
ちょっと自信がないけど頑張るわ。

去年の秋に大学入学資格試験に合格していたので、16歳のアリスには時間があった。
そして唯一の悩みは、普通の大学に行くか、魔術師養成校に行くかだった。
難易度は魔術師養成校のほうが高かった。
問題もさることながら、魔術師の適性や倍率などで入学が難しい学校として知れ渡っていたのだ。
しかし入学すれば、大学卒業の肩書だけでなく、給料まで出るのだ。
アリスは年老いたおばあさんと住んでいた。
母親も父親もいたが、外国で忙しく働いて仕送りをしているので、大学に行きたくても予算がない。
そういうわけで、もし社会的地位を上げたければ魔術師養成校に行くしかないのだ。

アリスは覚悟を決めた。
私は魔術師になる。

暗号の設計ばかりやってる間に、思いついたアリスの話のアイデアを全部忘れた。
漫画家とかアイデア勝負の人はいつでもアイデアを忘れないためにメモ帳を持ち歩いてすぐメモするらしいが、私はそうしなくてその場任せにしてしまって最終的に忘れる。
アリスとビジュネルがどんなバトルを繰り広げるかも忘れたし、その後アリスとビジュネルがどうなるかも忘れた。
恐るべき暗号の魔力！
アリスは魔術師を目指しているんだから当面魔術の勉強とかその流れで行けると思うけど、知ってる人は分かるようにこの話に通底するものは暗号技術へのオマージュだったりする。
どういうことをしたいかわからない人はまず先にこれを読むように。

そういえば最近まで笑わない数学とか数学に目を向けた番組が出てきたり、文系大学入学にも数学試験が必須になったり、数学嫌いには残念なことが増えている。そしてその分セキュリティとか暗号の価値も認知されるようになってきて、楽しい時間が増えているｗ

今からでも間に合うと思うので流れだけ書いておく。
アリスはあまりにビジュネルからの連絡がこないので諦めて魔術の訓練を始めた。
魔術とは確実性とは無縁の能力だ。
その威力や確実性は魔術師の魔力の強さだけによっている。
だから科学とは相性が悪い。
中には魔術と技術の融合を目指している研究者もいるようだが、その成功例が時空を飛び越えて通信する方法である匿名電報だったりする。
彼女は勉強の仮定で、ビジュネル暗号の解読法が一つではないことを知る。
そして解読法の種類や解き方を通してより強い暗号を作りたくなる。
そして安全でないことを理由に村人を説得し、ほかの方式を使うようにしようとしたが、村人は従わない。
そんなことをしたら自分たちが怪しまれると思ったのだ。
そもそもアリスが住む世界で暗号が使われているのは、通信の秘密を守るためだった。
封筒やはがきが禁止された結果、暗号の普及が一気に広まったのだ。
村人には失われたものがあるとアリスは思った。
今やロマーニャ帝国は監視国家だ。
国際締め手配中の帝国付属電子貨幣鋳造局に勤務していたデアルボルデーレは皇帝が市民を監視するために大量の通信を収集している証拠をジャーナリストに公開させ実証していた。
誰も言わなかったが、人々は常に帝国中央部から監視されて生活していることを知った。
アリスは監視社会は自動化された恐怖政治だという事を悟り、プライバシーを守るためには何が必要かを考えた。
監視されているときに人々は、なぜ怒りを感じないのか？
監視には萎縮効果がある。
人々は無意識のうちに自分の思考や行動を検閲するようになり自由を抑制する。
なぜ「自分は悪いことをしていないので監視されていてもかまわない」というのか？
それはアリスにとっては、自分にはプライバシーがありませんとか、その権利に興味がありません要りませんといっているように聞こえたのだ。
本来環氏は必要性のないときにするものではない。
だから市民生活を常に監視するのは異常なことだ。
人を疑うときに証拠が必要なのと同じように、監視にも当局がその必要性、理由を説明しなければならない責任がある。
ところが今の帝国はこの責任を果たしていない。
ありとしたら犯罪防止や、テロ対策という名目を繰り返しているだけだった。
果たして監視で犯罪が減る効果はあるのだろうか？
恐怖政治はこうして市民生活に浸透していく。
今や善悪の判断は国がすることになり、その人個人の判断ではなくなったのだ。
人々は常にいつどういう理由で逮捕されるか、おびえながら生活しているのであった。

アリスは小さな時から人目を気にする神経質な子供だった。
アリスは9歳で暗号を発明して実際に日記に使っていた。
学校でメモ帳を盗まれたりしたことがあったので、見られても恥ずかしい思いをしなくて済むように暗号が必要だったのだ。
しかしそれは今でいうメアリの暗号で、文章に使われる文字の頻度分布を調べれば解読できてしまうものだった。
アリスはつい最近まで当時最強と言われていた手書き暗号のビジュネル暗号を常に使っていた。
しかし使い慣れてくると規則性が見えてくるようになり、実際解読を試みたところ成功した。
それが今に至る経緯だった。
アリスは落胆して今度は暗号開発に夢中になる。
自分は監視社会に対抗するために暗号を研究する必要があると思っていた。

一方ビジュネルは不安になりながらも得体のしれない紙のような電報の返事をどうするか迷っていた。
考えた結果、アリスの挑戦を受けることに決めた。
或いは無視するか、この辺で話の展開が分れてしまうｗ
ビジュネルはその後どうなったのか？
新しい暗号を開発したのか？
第一部ではアリスがオリジナルの暗号を開発して、皇帝の陰謀を暴露するという功績のためにEMSに推薦入学できたということにしておこうと思う。

Qiiitaで連載したときは軒並み1000ビューを超えていたのに、オタクサイトで公開してもほとんど反応がないというのは対象的だ。
みんな理系の才能なさすぎ。
というか2000年の辞典で暗号技術をネタにした小説を書くというのは早すぎたのだ。
当時はQiitaやZennのような技術ネタでエンジニアが交流するサイトなんかなかったし、オタクサイトばかり反映していて常に不満だった。
でも今は違うし、ニッチなニーズに満たされている。
それは長らく放置されていた理系のニーズだったのだ。
まあ関係ないけどw

外交官であるビジュネルは自分の開発した暗号が説かれることに対して敏感だった。
まさに死活問題。
その結果アリスに新しい暗号の設計を協力するように伝えるのだった。
その後のもう一羽はその辺に書いてあるので後で書きます。
あ、確かアルルの話だ。
アルルは8歳で魔術師になり、11歳で魔導士としてプロデビューした特別な子供だった。
アルルの年齢は15歳でアリスより1つ年下だった。
アルルの修道院の中の儀式のこと。
アルルの兄既約であるパレーシャのこと
修道院にある人力計算機のこと
アルルの育ての親であるカトレイ院長のこと
アルルの僧院での役割と日常生活
アルルの暗号や密使との関係
アリスが儀式に参加しようとして守りの長に断られること
素人が参加できるようなものではなく、出席するには3人以上の専門家の推薦と参加費用8間年が必要だったこと
唯一素人が参加できそうなのは、暗号品評会だったこと。
ボブというアリスのライバル登場
暗号解読という数理パズル
あとなんかあったきがするがこのくらいでいいかも
暗号というのは文系が書くミステリの中の切られ役なんかじゃないし、脇役でもない。
暗号を主役にした小説が書きたい
あと悪魔が出てこないといけないんだけどはるか先でないと無理
アリスはのちに安全にビジュネル暗号を使う方法も考案し実践する。（文書フォーマットを工夫する）

（世界観は日本とヨーロパが混ざったような感じです。）
アリスは乗合馬車の事務所に行って、カルカソンヌ行きの予約をして家に帰った。
東京のはるか郊外の村に住んでいるアリスにとっては、都心に行くより馬車でカルカソンヌに行くほうが近かったのだ。

翌日、午後のカルカソンヌ域乗合馬車に乗ると一時間ほどで街についた。
早速帝国郵便局に行って、匿名電報権を１０枚買った。
使用欄には個人情報と書いておいた。
相手が確実に受け取ったことを確認できるように、簡易書留にした。

その後アリスは帝国図書館に行って、アルルの言っていた「知恵の秘技」に関する本を調べた。
だが結局蔵書検索では出てこなかった。
秘密の聖典である知恵の秘技は一般人には手に入らないのかも知れない。

図書館のドアを出る前に、除籍本のコーナーが有ったので、なにか面白そうな本がないか除いてみた。
すると、そこには知恵の秘技なる分厚くて硬い革の表紙の本があったではないか！
アリスは喜んでその本を家に持ち帰った。

この本を読み通すのは難しいだろうなあ。

とは思いつつ、アリスは微ジュネルに暗号解読法を見つけたことを知らせる方法を実践し始めた。
まずスマホで匿名電報のIDを読み取った。
すると文書の入力欄が出てきたので、そこに次のような文書を書いた。

拝啓ビジュネル様。
あなたの発明した暗号であるビジュネル暗号の解読法を見つけたのでお知らせします。
名前は当局に知られると面倒なので言えません。
私が何者であるか聞かないでください。
あえて言うなら、私はしがない魔術師見習いです。
解読法なんてもう知っているというのであれば、この電報を無視して構いません。
しかしそんな方法があるとは信じられないというのであれば、私があなたを納得させましょう。
解読法は秘密です。
なので他に知られることはありません。
早速新しい暗号を開発なさるのが良いかと存じます。

さてその方法ですが、私がビジュネル様あてにこれを含めて２枚の電報を送ります。
まずこの電報を、ビジュネル様がパスワードで暗号化してお繰り返してください。
もう一枚の電報には、ビジュネル様が意味のない乱数を書いて送ってください。
料金は着払いで構いません。
私がその１枚の暗号文からパスワードを見つけましょう。
私が送った２枚目の乱数が書かれた電報に、私が解読したパスワードを書き込み、メッセージ指紋を取って送り返します。
すると、ビジュネル様はもうすでにパスワードと乱数をご存知ですので、同じようにメッセージ指紋を取っておなじになることを確認します。
２つのメッセージ指紋が一致するということは、私がビジュネル様と同じパスワードを知っているということに違いありません！
まぐれだと思うなら何回でもやり直します。
なので、もし私がパスワードを知ることができるということが信じられないのであれば、ぜひ返事をいただきたいのです。
それでは失礼致します。（chapのことだというのはわかる人にはわかるはずなんですがｗ）
A

アリスがスマホの送信ボタンを押すと、電報の表面は情報を記録した魔法陣に変わって、ビジュネル宛に消えていった。

アリスの味方に誰を出せばいいですかね
やっぱり暗号の何が楽しいかといえば、私でも作れるけど、東大生にも解けないというところですね。
そんなもんいくらでもありますよw
それが能力を持つ人間との均衡を保つ役割をすれば目的を果たしていると言えそうです。
返信する15分
イブを出すかどうか。
出しましょう
悪役の定番だし
アリスとボブの通信をeveが邪魔するのが王道
ボブはライバルなんです。アリス未満の人がどういう生活をしているか、帝国内の国民の暮らしを描かないといけない。
競争社会では才能のない人間が一番惨めなのだということを欠かないといけない
小公女のベッキーみたいな感じの子ｗ
だからボブはアリスをいじめるんです
イブでもいいか
ちなみにアルルはゲイですｗ
ボブかイブは帝国から送り込まれてスパイという感じ
ボブとイブが中が良くてアリスを暗殺しようとしている。アリスが二人の通信を解読して自分の身を守る。それを助けてくれるのがあるるとか
彼らの共通点は弱者に対する冷酷さだ。つまり、困るやつが悪い、困ったら自殺すればいいという考えだ。
困るやつが悪い。エゴイズムの極致。正に図星か。
アルルとアリスは最終的に敵対関係になるという設定のほうが面白いかもしれないなあ。
ある国が民主主義に反することをしたとしても、国民にはそれに対抗する手段が殆どない。
もしあるとするなら、暗号がその一つかもしれない。
実力主義の社会では、才能のない人間が一番惨めなのだ。
それを自ら知っていたイブは世界を呪う。
イブは魔術師の試験に落ちたが、そのダークエネルギーにより黒魔道士の能力に目覚めてしまう。
そして南部地方の破壊を目論む帝国軍と合流し、黒魔術を使い破壊の限りを尽くす。
この戦闘をきっかけに、アルルは帝国の黒魔術の力を封印するための旅が始まる。
で、ここでアリスとアルル離れ離れになる。
どーなるんでしょうねー
残されたアリスは魔術の能力がなかったため入学資格を失ったが、科学の成績が良かったので補欠で無料のEMS付属魔術設計士養成校に入学することになる。
肝心の数秘術が出てこないんですが、何をネタにすべきか未定。
アリスの話なので暗号メインで行く予定。

ビジュネルの返事は来ない。
多分本人も暗号の解読法に気づいているに違いない。

アリスは知恵の秘技の本を読んでいた。
まず最初にシーザー暗号という簡単な暗号化と、その解読法についておさらいした。
最初の方はとても簡単で、アリスには退屈だったけれども。

シーザー暗号とは、アルファベットを数字に割り当て、そこに鍵となる1つの数を選んで足し、アルファベットの数で割った余りを暗号文とするものだ。

ここで平文を数字に変換した数を$m_i$、アルファベットの数をｎとすると、暗号文は以下のように表現できる。
鍵：K
暗号化：$c_i=m_{i+K % n}$

これはダメね。
同じ鍵をアルファベットに足しているだけだもの。
平文と暗号文のペアがあれば、暗号文から平文を引いたら秘密鍵Kの値がわかってしまう。
だから、ダメ。
他にも頻度分布かなんかで解けそうね。
もっと解読法がありそう。
この本には使ってはいけない暗号や、安全な暗号の種類や使い方も載っているから、先に進むに従ってより詳しい暗号の知識を得ることができそうね。
あとでパソコンで作って解読してみよう。
そういえばアルルが隣の村ではシフト暗号、つまりシーザー暗号と同じものが安全だと言われて使っているらしいし、暗号を使うようにという帝国の司令があっても安全でない暗号を使ったら意味がない。
まあ、隣の村にその事を言っても誰も相手にしそうにないわね。

次は換字暗号ね。
これは私が小学生の時に作った暗号。
だからよく知ってるんだけど、もう一度おさらいしてみるわ。

その時、アリスの目の前にきらめく光が見えた。

電報だわ。
きっとビジュネル氏ね。

やっと返事が届いた。
でもアリスにはもう一つ気になることがあった。
村から一番近い街で、暗号コンテストが開かれるのである。
その予選を見に行く予定だったのだ。
今からいかないと間に合わない。

アリスは机の引き出しに匿名電報をしまうと、町に向かって自転車を走らせた。

